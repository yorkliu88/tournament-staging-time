<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Match Schedule Update</title>
<style>
  body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#fafafa;color:#111}
  .wrap{max-width:900px;margin:0 auto;padding:24px}
  .card{background:#fff;border:1px solid #eaeaea;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px 20px;margin-bottom:18px}
  .title{font-weight:700;font-size:20px;margin-bottom:8px}
  .muted{color:#666;font-size:14px}
  input[type=text],input[type=number]{width:100%;padding:10px 12px;border:1px solid #eaeaea;border-radius:10px;font:inherit}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #eaeaea;background:#111;color:#fff;font-weight:600;cursor:pointer}
  .ok{color:#0b7c3e}
  .warn{color:#c62828}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-top:1px solid #eee;text-align:left}
  thead th{background:#f7f7f7}
</style>
<!-- SheetJS for XLSX parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0 0 12px">Match Schedule Update</h1>

  <div class="card">
    <div class="title">1) Google Apps Script Web App URL</div>
    <div class="muted">Paste the Web App URL you deployed from Apps Script (step A).</div>
    <input id="endpoint" type="text" placeholder="https://script.google.com/macros/s/AKfycb.../exec" />
  </div>

  <div class="card">
    <div class="title">2) Upload Tournament XLSX</div>
    <div class="muted">Drop your tournament export (.xlsx). We’ll parse & normalize columns automatically.</div>
    <input id="xlsxInput" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
    <div style="margin-top:10px" class="row">
      <div>
        <label class="muted">Staging Hour (0–23)</label>
        <input id="stagingHour" type="number" min="0" max="23" />
      </div>
      <div>
        <label class="muted">Staging Minute (0–59)</label>
        <input id="stagingMinute" type="number" min="0" max="59" />
      </div>
    </div>
    <div style="margin-top:10px">
      <button class="btn" id="sendBtn">Send to Google Sheet</button>
      <span id="status" style="margin-left:10px" class="muted">Idle</span>
    </div>
  </div>

  <div class="card">
    <div class="title">Preview (first 20 rows)</div>
    <div class="muted">Normalized columns: ID, Time, Event, Round, Court, Team 1, Team 2, Score, Start, Finish</div>
    <div style="overflow:auto">
      <table>
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const endpointEl = document.getElementById('endpoint');
  const xlsxInput = document.getElementById('xlsxInput');
  const stagingHourEl = document.getElementById('stagingHour');
  const stagingMinuteEl = document.getElementById('stagingMinute');
  const sendBtn = document.getElementById('sendBtn');
  const statusEl = document.getElementById('status');
  const theadEl = document.getElementById('thead');
  const tbodyEl = document.getElementById('tbody');
  let normalizedRows = [];

  function toKey(s){return String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');}

  // normalize to stable schema
  function normalizeSheet(jsonRows){
    const out=[];
    for(const r of jsonRows){
      const row={}; for(const [k,v] of Object.entries(r)) row[toKey(k)]=v;
      const id=row.id||row.match_id||row.nr||'';
      const time=row.time||row.estimated_start||row.est_start||row.start_time||'';
      const event=row.event||row.division||row.category||'';
      const round=row.round||row.stage||'';
      const court=row.court||row.court_name||'';
      const team1=row.team_1||row.team1||row.player_a||row.player1||'';
      const team2=row.team_2||row.team2||row.player_b||row.player2||'';
      const score=row.score||row.result||'';
      const start=row.start||row.actual_start||'';
      const finish=row.finish||row.end||'';
      if(team1||team2){
        out.push({
          "ID":String(id||''),"Time":String(time||''),"Event":String(event||''),
          "Round":String(round||''),"Court":String(court||''),
          "Team 1":String(team1||''),"Team 2":String(team2||''),
          "Score":String(score||''),"Start":String(start||''),"Finish":String(finish||'')
        });
      }
    }
    return out;
  }

  function renderPreview(rows){
    tbodyEl.innerHTML=''; theadEl.innerHTML='';
    if(!rows.length) return;
    const headers=Object.keys(rows[0]);
    for(const h of headers){const th=document.createElement('th');th.textContent=h;theadEl.appendChild(th);}
    for(const r of rows.slice(0,20)){
      const tr=document.createElement('tr');
      tr.innerHTML=headers.map(h=>`<td>${escapeHtml(r[h])}</td>`).join('');
      tbodyEl.appendChild(tr);
    }
  }
  function escapeHtml(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;');}

  xlsxInput.addEventListener('change',async e=>{
    const file=e.target.files?.[0]; if(!file)return;
    statusEl.textContent='Parsing XLSX…';
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:'array'});
    let firstJson=[];
    for(const name of wb.SheetNames){
      const ws=wb.Sheets[name];
      const json=XLSX.utils.sheet_to_json(ws,{defval:''});
      if(json.length){firstJson=json;break;}
    }
    normalizedRows=normalizeSheet(firstJson);
    renderPreview(normalizedRows);
    statusEl.innerHTML=`<span class=\"ok\">Parsed ${normalizedRows.length} rows.</span>`;
  });

  sendBtn.addEventListener('click',async()=>{
    const endpoint=(endpointEl.value||'').trim();
    if(!endpoint){alert('Please paste your Apps Script Web App URL.');return;}
    if(!normalizedRows.length){alert('Please upload an XLSX first.');return;}
    const hour=stagingHourEl.value===''?undefined:Number(stagingHourEl.value);
    const minute=stagingMinuteEl.value===''?undefined:Number(stagingMinuteEl.value);
    const body={
      matches:normalizedRows,overwrite:true,
      stagingHour:(typeof hour==='number'&&!isNaN(hour))?hour:undefined,
      stagingMinute:(typeof minute==='number'&&!isNaN(minute))?minute:undefined
    };
    try{
      statusEl.textContent='Sending to Google Sheet…';
      const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),mode:'cors'});
      const j=await r.json();
      if(!j.ok)throw new Error(j.error||'Unknown error');
      statusEl.innerHTML=`<span class=\"ok\">Wrote ${j.rows} rows to Matches. Staging updated if provided.</span>`;
    }catch(err){
      statusEl.innerHTML=`<span class=\"warn\">Failed: ${String(err)}</span>`;
    }
  });
})();
</script>
</body>
</html>
