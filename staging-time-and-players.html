<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Staging Time & Players</title>
<style>
  body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#fafafa;color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:#fff;border:1px solid #eaeaea;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px 20px;margin-bottom:18px}
  .muted{color:#666;font-size:13px}
  .ok{color:#0b7c3e;font-size:22px;font-weight:700}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-top:1px solid #eee;text-align:left}
  thead th{background:#f7f7f7}
</style>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div id="stagingTimeBig" class="ok">Loading…</div>
    <div id="refreshLine" class="muted">
      Auto-refresh every 60s • Est. Start assumes 30-min matches
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:20px;font-weight:700;margin:0 0 10px;">Staging Players</h2>
    <div class="muted" id="playersEmpty">Loading…</div>
    <div style="overflow:auto;">
      <table id="playersTable" style="display:none;">
        <thead>
          <tr>
            <th>Player 1</th><th>Player 2</th><th>Division</th><th>Round</th>
            <th>Court</th><th>Match ID</th><th>Scheduled</th><th>Est. Start</th>
          </tr>
        </thead>
        <tbody id="playersBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const { DateTime } = luxon;
  const zone = "America/Los_Angeles";

  const stagingCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTCnxXDwQE5lgVWkm51FKG48ZPYtOYYQN4Zj-w1M1j6giv69A_CDSSIZQHTtk0ouVg06xH_uGHa-i5A/pub?gid=0&single=true&output=csv";
  const matchesCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSiikhANBenfXD_aaQTFjMPDDozxaPFdn986N9Q9k9AzKD9NycWNblIOcGyNrhRHSIXNkBF4SrLksMU/pub?gid=0&single=true&output=csv";

  const MATCH_DURATION_MIN = 30, DEFAULT_REMAINING_MIN = 15;
  const stagingTimeBigEl = document.getElementById("stagingTimeBig");
  const refreshLineEl = document.getElementById("refreshLine");
  const playersEmptyEl = document.getElementById("playersEmpty");
  const playersTableEl = document.getElementById("playersTable");
  const playersBodyEl = document.getElementById("playersBody");

  let matchesRows = [], stagingHour=null, stagingMinute=null;

  function toKey(s){return String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');}
  function parseDateAny(s){
    if(!s)return null;
    const raw=String(s).trim();
    const d1=Date.parse(raw);
    if(!Number.isNaN(d1))return DateTime.fromMillis(d1).setZone(zone);
    const fmts=["EEE M/d/yyyy h:mm a","M/d/yyyy h:mm a","yyyy-MM-dd HH:mm"];
    for(const f of fmts){const dt=DateTime.fromFormat(raw,f,{zone});if(dt.isValid)return dt;}
    return null;
  }
  async function fetchCsvText(url){const r=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now(),{cache:"no-store"});return await r.text();}
  function cutoffForMatchDate(matchDt,hour,minute){if(!matchDt)return null;return matchDt.set({hour,minute,second:0,millisecond:0});}

  async function loadStaging(){
    const txt=await fetchCsvText(stagingCsvUrl);
    let hour=null,minute=null;
    const p=Papa.parse(txt,{header:true,skipEmptyLines:true});
    if(p.data&&p.data.length){const first=p.data[0];const hourKey=Object.keys(first).find(k=>/hour/i.test(k))||Object.keys(first)[0];
      const minKey=Object.keys(first).find(k=>/min/i.test(k))||Object.keys(first)[1];
      hour=Number(first[hourKey]);minute=Number(first[minKey]);}
    if(isNaN(hour)||isNaN(minute)){stagingHour=stagingMinute=null;stagingTimeBigEl.textContent="Unavailable";return;}
    stagingHour=hour;stagingMinute=minute;
    const display=DateTime.now().setZone(zone).set({hour,minute});
    stagingTimeBigEl.textContent="Staging Time: "+display.toFormat("t");
  }

  async function loadMatches(){
    const txt=await fetchCsvText(matchesCsvUrl);
    const out=Papa.parse(txt,{header:true,skipEmptyLines:true});
    matchesRows=(out.data||[]).map(r=>{
      const o={};for(const[k,v]of Object.entries(r))o[toKey(k)]=v;
      const timeStr=o.time||o.estimated_start||o.est_start||"";
      const startStr=o.start||o.actual_start||"";
      return{id:o.id||o.match_id||o.nr||"",time:parseDateAny(timeStr),start:parseDateAny(startStr),
        event:o.event||o.division||"",round:o.round||"",court:(o.court||"").trim(),
        a:o.team_1||o.player_a||o.player1||o.team1||"",b:o.team_2||o.player_b||o.player2||o.team2||"",
        score:(o.score||"").trim()};}).filter(r=>r.a||r.b);
  }

  function simulateEtas(activeCourtsRemainingMin,stagedCount){
    const now=DateTime.now().setZone(zone);
    let lanes=activeCourtsRemainingMin.slice();if(!lanes.length)lanes=[0];
    const etas=[];
    for(let i=0;i<stagedCount;i++){let idx=0;for(let j=1;j<lanes.length;j++)if(lanes[j]<lanes[idx])idx=j;
      const etaMin=Math.max(0,lanes[idx]);etas.push(now.plus({minutes:etaMin}));lanes[idx]=etaMin+MATCH_DURATION_MIN;}
    return etas;
  }

  function renderPlayers(){
    const now=DateTime.now().setZone(zone);
    if(stagingHour==null||stagingMinute==null||!matchesRows.length){
      playersEmptyEl.textContent="Waiting for data…";playersTableEl.style.display="none";return;
    }
    const inProgress=matchesRows.filter(m=>m.court&&!m.score);
    const remainingPerCourt=inProgress.map(m=>{
      if(m.start&&m.start.isValid){const elapsed=Math.max(0,now.diff(m.start,'minutes').minutes);return Math.max(0,MATCH_DURATION_MIN-elapsed);}
      return DEFAULT_REMAINING_MIN;});
    let C=remainingPerCourt.length;
    if(C===0){const distinctCourts=new Set(matchesRows.map(m=>m.court).filter(Boolean));C=Math.max(1,distinctCourts.size||1);}
    function eligibleByCutoff(m){if(!m.time)return false;const cutoff=cutoffForMatchDate(m.time,stagingHour,stagingMinute);if(!cutoff)return false;if(m.score)return false;return m.time<=cutoff;}
    const queued=matchesRows.filter(m=>!m.court&&eligibleByCutoff(m)).sort((a,b)=>(a.time?.toMillis()||0)-(b.time?.toMillis()||0));
    const onCourt=matchesRows.filter(m=>m.court&&!m.score&&eligibleByCutoff(m));
    const activeRemaining=remainingPerCourt.slice(0,Math.max(1,C));while(activeRemaining.length<C)activeRemaining.push(0);
    const etas=simulateEtas(activeRemaining,queued.length);
    const all=[...onCourt.map(m=>({m,etaLabel:"Playing",eta:now})),...queued.map((m,i)=>({m,etaLabel:(etas[i]||now).toFormat("t"),eta:etas[i]||now}))];
    if(!all.length){playersEmptyEl.textContent="No matches to stage right now.";playersTableEl.style.display="none";
      refreshLineEl.textContent=`Auto-refresh every 60s • Est. Start assumes 30-min matches • Courts in play: ${C}, Queue: 0`;return;}

    all.sort((x,y)=>(x.eta?.toMillis()||0)-(y.eta?.toMillis()||0));
    playersEmptyEl.textContent="";playersTableEl.style.display="table";playersBodyEl.innerHTML="";
    for(const r of all){
      const m=r.m;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${escapeHtml(m.a)}</td><td>${escapeHtml(m.b)}</td>
        <td>${escapeHtml(m.event)}</td><td>${escapeHtml(m.round)}</td>
        <td>${escapeHtml(m.court||"—")}</td><td>${escapeHtml(m.id||"")}</td>
        <td>${m.time?m.time.toFormat("t"):"—"}</td><td>${r.etaLabel||"—"}</td>`;
      playersBodyEl.appendChild(tr);
    }
    refreshLineEl.textContent=`Auto-refresh every 60s • Est. Start assumes 30-min matches • Courts in play: ${C}, Queue: ${queued.length}`;
  }

  function escapeHtml(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;');}
  async function refreshAll(){try{await Promise.all([loadStaging(),loadMatches()]);renderPlayers();}
    catch(e){stagingTimeBigEl.textContent="Error";playersEmptyEl.textContent="Error";refreshLineEl.textContent="Error";}}
  refreshAll();setInterval(refreshAll,60000);
})();
</script>
</body>
</html>
